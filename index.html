<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nose.h.k | sensory discovery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="public/icon.png" type="image/png">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .filter-btn.active { background-color: #343a40; color: #ffffff; }
        .sense-btn.active { background-color: #495057; color: #ffffff; border-color: #495057; }
        .result-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .result-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; }
        .modal-enter .modal-content-transform { transform: scale(0.95) translateY(20px); }
        .modal-enter-active .modal-content-transform { transform: scale(1) translateY(0); }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* â–¼â–¼â–¼ NEW STYLES FOR TAB BAR â–¼â–¼â–¼ */
        .tab-btn {
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            border-top: 3px solid transparent;
            padding-top: 12px; /* Adjust padding to align icon and text */
            padding-bottom: 8px;
        }
        .tab-btn.active {
            color: #343a40; /* Dark text for active */
            font-weight: 600;
            border-top-color: #343a40; /* Dark border for active */
        }
        /* â–²â–²â–² NEW STYLES FOR TAB BAR â–²â–²â–² */
    </style>
</head>
<!-- â–¼â–¼â–¼ ADDED pb-24 TO BODY â–¼â–¼â–¼ -->
<body class="text-gray-800 pb-24">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20 border-b border-gray-200">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <img src="public/icon.png" alt="logo" class="h-8 w-8">
                    <div>
                        <h1 class="text-lg font-bold">nose.h.k</h1>
                        <p class="text-xs text-gray-500">Sensory Discovery</p>
                    </div>
                </div>

				<div class="flex items-center gap-2 text-sm font-medium">
                    <a href="https://forms.gle/n4Z4Wd1f6MJ3yVGq8" target="_blank" class="py-2 px-4 rounded-md hover:bg-gray-100 transition-colors">
                        å°åº—/æ´»å‹•ç™»è¨˜
                    </a>
                    <!-- Auth Section -->
                    <div id="auth-container" class="flex items-center gap-2 text-sm font-medium">
                        <!-- This will be populated by the auth script -->
					</div>
                </div>
            </div>
        </div>
    </header>

    <!-- â–¼â–¼â–¼ NEW: Explore View Container â–¼â–¼â–¼ -->
    <div id="explore-view">
        <!-- Main Content -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Search and Results sections remain the same -->
            <section id="filters" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
                <h2 class="text-xl font-bold mb-1">Discover by senses â€”</h2>
                <p class="text-gray-500 mb-4">Pick one or more senses and explore Events & Local Shops curated for you.</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div id="senses-container" class="flex flex-wrap gap-2 items-center"></div>
                    <div class="flex-grow flex flex-col sm:flex-row gap-2 mt-2 sm:mt-0">
                        <select id="district-select" class="w-full sm:w-40 p-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                            <option value="all">æ‰€æœ‰åœ°å€</option>
                        </select>
                        <input type="text" id="search-input" placeholder="æœå°‹æ´»å‹•æˆ–å°åº—..." class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                    </div>
                </div>
            </section>

            <section id="results-container">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2 text-sm font-medium">
                        <button data-filter="all" class="filter-btn active py-2 px-4 rounded-md bg-gray-200">å…¨éƒ¨</button>
                        <button data-filter="events" class="filter-btn py-2 px-4 rounded-md hover:bg-gray-200">æ´»å‹•</button>
                        <button data-filter="places" class="filter-btn py-2 px-4 rounded-md hover:bg-gray-200">æœ¬åœ°å°åº—</button>
                    </div>
                    <p id="results-count" class="text-sm text-gray-500"></p>
                </div>
                <div id="loader" class="text-center py-10"><p class="text-gray-500">æ­£åœ¨åŠ è¼‰é«”é©—...</p></div>
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-results" class="hidden text-center py-16">
                    <p class="text-lg text-gray-600">æ‰¾ä¸åˆ°ä»»ä½•é«”é©—ã€‚</p>
                    <p class="text-gray-500">è«‹å˜—è©¦èª¿æ•´ä½ çš„ç¯©é¸æ¢ä»¶ã€‚</p>
                </div>
            </section>
        </main>
        <!-- Footer -->
        <footer class="text-center py-8 mt-8 border-t border-gray-200">
            <p class="text-sm text-gray-500" data-lang-key="copyright">ç‰ˆæ¬Šæ‰€æœ‰ Â© 2025 nostartnoend.hk</p>
        </footer>
    </div>
    <!-- â–²â–²â–² END: Explore View Container â–²â–²â–² -->


    <!-- â–¼â–¼â–¼ NEW: Plan Trip View Container â–¼â–¼â–¼ -->
    <div id="plan-view" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- This content is shown when the user is LOGGED OUT -->
        <div id="plan-login-prompt" class="hidden text-center py-16">
            <div class="flex justify-center mb-4">
                <svg class="w-16 h-16 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">è«‹å…ˆç™»å…¥</h2>
            <p class="text-gray-500 mb-6">ç™»å…¥å¾Œå³å¯é–‹å§‹å»ºç«‹åŠå„²å­˜æ‚¨çš„å°ˆå±¬æ„Ÿå®˜è¡Œç¨‹ã€‚</p>
            <button id="plan-login-btn" class="bg-gray-800 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">
                ä½¿ç”¨ Google ç™»å…¥
            </button>
        </div>

        <!-- This content is shown when the user is LOGGED IN -->
        <div id="plan-content" class="hidden">
            <h2 class="text-2xl font-bold mb-4">æˆ‘çš„è¡Œç¨‹</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <p class="text-gray-500">ã€Œè¨ˆåŠƒè¡Œç¨‹ã€åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                <p class="text-gray-500 mt-2">æœªä¾†æ‚¨å¯ä»¥åœ¨é€™è£¡å»ºç«‹æ–°çš„è¡Œç¨‹ï¼Œä¸¦å°‡ã€Œæ¢ç´¢ã€é é¢ä¸­çš„å°åº—å’Œæ´»å‹•åŠ å…¥åˆ°æ‚¨çš„è¡Œç¨‹ä¸­ã€‚</p>
            </div>
            <!-- Future UI for creating/viewing plans will go here -->
        </div>
    </div>
    <!-- â–²â–²â–² END: Plan Trip View Container â–²â–²â–² -->

    
    <!-- Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-30 modal-enter">
        <div id="modal-content" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-white rounded-2xl shadow-xl p-4 sm:p-6 modal-content-transform"></div>
    </div>

    <!-- â–¼â–¼â–¼ NEW: Bottom Tab Bar â–¼â–¼â–¼ -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 z-50 bg-white border-t border-gray-200 shadow-md">
        <div class="container mx-auto max-w-lg">
            <div class="flex justify-around items-stretch">
                <!-- Explore Tab -->
                <button id="tab-explore" class="tab-btn active flex-1 flex flex-col items-center justify-center text-gray-500">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                    <span class="text-xs mt-1">æ¢ç´¢</span>
                </button>
                <!-- Plan Trip Tab -->
                <button id="tab-plan" class="tab-btn flex-1 flex flex-col items-center justify-center text-gray-500">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                    <span class="text-xs mt-1">è¨ˆåŠƒè¡Œç¨‹</span>
                </button>
            </div>
        </div>
    </nav>
    <!-- â–²â–²â–² END: Bottom Tab Bar â–²â–²â–² -->
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
        const firebaseConfig = {
		  apiKey: "AIzaSyA4REPPkvavljPA_MD135X6n0D9h2M59dE",
		  authDomain: "nosehk-46e0d.firebaseapp.com",
		  projectId: "nosehk-46e0d",
		  storageBucket: "nosehk-46e0d.firebasestorage.app",
		  messagingSenderId: "1062820436301",
		  appId: "1:1062820436301:web:d96b78c57d363ddfff7f04",
		  measurementId: "G-XH1GLTDT9G"
		};
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Senses configuration
        const SENSES = ['Eye', 'Ear', 'Nose', 'Tongue', 'Body', 'Mind'];
        const SENSES_ZH = ['çœ¼', 'è€³', 'é¼»', 'èˆŒ', 'èº«', 'æ„'];

        // State variables
        let allPlaces = [];
        let allEvents = [];
        let currentFilter = 'all';
        let currentView = 'explore'; // â–¼â–¼â–¼ NEW STATE â–¼â–¼â–¼

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const sensesContainer = document.getElementById('senses-container');
        const districtSelect = document.getElementById('district-select');
        const searchInput = document.getElementById('search-input');
        const resultsGrid = document.getElementById('results-grid');
        const loader = document.getElementById('loader');
        const noResults = document.getElementById('no-results');
        const resultsCount = document.getElementById('results-count');
        const resultFilterButtons = document.querySelectorAll('.filter-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');

        // â–¼â–¼â–¼ NEW DOM ELEMENTS â–¼â–¼â–¼
        const exploreView = document.getElementById('explore-view');
        const planView = document.getElementById('plan-view');
        const tabExplore = document.getElementById('tab-explore');
        const tabPlan = document.getElementById('tab-plan');
        const planLoginPrompt = document.getElementById('plan-login-prompt');
        const planContent = document.getElementById('plan-content');
        const planLoginBtn = document.getElementById('plan-login-btn');
        // â–²â–²â–² NEW DOM ELEMENTS â–²â–²â–²

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();

        function handleSignIn() {
            signInWithPopup(auth, provider).catch(error => console.error("Sign in error:", error));
        }

        function handleSignOut() {
            signOut(auth).catch(error => console.error("Sign out error:", error));
        }

        onAuthStateChanged(auth, user => {
            // Update header auth button
            authContainer.innerHTML = '';
            if (user) {
                authContainer.innerHTML = `
                    <img src="${user.photoURL}" alt="${user.displayName}" class="w-8 h-8 rounded-full">
                    <button id="logout-btn" class="py-2 px-4 rounded-md hover:bg-gray-100 transition-colors">ç™»å‡º</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            } else {
                authContainer.innerHTML = `<button id="login-btn" class="bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors">Google ç™»å…¥</button>`;
                document.getElementById('login-btn').addEventListener('click', handleSignIn);
            }

            // â–¼â–¼â–¼ NEW LOGIC â–¼â–¼â–¼
            // If the user's auth state changes, re-render the plan view
            // in case they are currently looking at it.
            if (currentView === 'plan') {
                renderPlanView(user);
            }
            // â–²â–²â–² NEW LOGIC â–²â–²â–²
        });

        // --- â–¼â–¼â–¼ NEW FUNCTIONS FOR VIEW SWITCHING â–¼â–¼â–¼ ---

        /**
         * Switches the main view between 'explore' and 'plan'
         * @param {string} viewName - 'explore' or 'plan'
         */
        function showView(viewName) {
            currentView = viewName;
            
            if (viewName === 'explore') {
                // Show Explore View
                exploreView.classList.remove('hidden');
                planView.classList.add('hidden');
                // Update Tab UI
                tabExplore.classList.add('active');
                tabPlan.classList.remove('active');
            } else if (viewName === 'plan') {
                // Show Plan View
                exploreView.classList.add('hidden');
                planView.classList.remove('hidden');
                // Update Tab UI
                tabExplore.classList.remove('active');
                tabPlan.classList.add('active');
                
                // Render the content of the plan view based on auth state
                renderPlanView(auth.currentUser);
            }
        }

        /**
         * Renders the content of the "Plan Trip" view based on user auth state
         * @param {object|null} user - The Firebase auth user object or null
         */
        function renderPlanView(user) {
            if (user) {
                // User is logged in, show the trip planner content
                planLoginPrompt.classList.add('hidden');
                planContent.classList.remove('hidden');
                // TODO: Load user's saved plans from Firestore
                planContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">æˆ‘çš„è¡Œç¨‹</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <p class="text-gray-500">ã€Œè¨ˆåŠƒè¡Œç¨‹ã€åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</p>
                        <p class="text-gray-500 mt-2">æœªä¾†æ‚¨å¯ä»¥åœ¨é€™è£¡å»ºç«‹æ–°çš„è¡Œç¨‹ï¼Œä¸¦å°‡ã€Œæ¢ç´¢ã€é é¢ä¸­çš„å°åº—å’Œæ´»å‹•åŠ å…¥åˆ°æ‚¨çš„è¡Œç¨‹ä¸­ã€‚</p>
                    </div>
                `;
            } else {
                // User is logged out, show the login prompt
                planLoginPrompt.classList.remove('hidden');
                planContent.classList.add('hidden');
            }
        }
        // --- â–²â–²â–² NEW FUNCTIONS FOR VIEW SWITCHING â–²â–²â–² ---


        // --- DATA FETCHING (Unchanged) ---
        function fetchData() {
            loader.style.display = 'block';
            const handleSnapshot = (snapshot, type) => {
                const dataArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (type === 'places') allPlaces = dataArray;
                if (type === 'events') allEvents = dataArray;
                populateDistricts();
                performSearch();
            };

            const handleError = (type, error) => {
                console.error(`Error fetching ${type}:`, error);
                loader.style.display = 'none';
                resultsGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
            };

            onSnapshot(collection(db, "places"), (snap) => handleSnapshot(snap, 'places'), (err) => handleError('places', err));
            onSnapshot(collection(db, "events"), (snap) => handleSnapshot(snap, 'events'), (err) => handleError('events', err));
        }
        
        // --- HELPER FUNCTIONS (Unchanged) ---
        function stringToColor(str) {
            if (!str) return '#cccccc';
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }
        
        function populateSenses() {
            sensesContainer.innerHTML = SENSES.map((sense, index) => 
                `<button data-sense="${sense}" class="sense-btn border border-gray-300 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-100 transition-colors">${SENSES_ZH[index]}</button>`
            ).join('');
            sensesContainer.addEventListener('click', e => {
                if (e.target.classList.contains('sense-btn')) {
                    e.target.classList.toggle('active');
                    performSearch();
                }
            });
        }

        function populateDistricts() {
            const currentSelection = districtSelect.value;
            const districts = [...new Set([...allPlaces.map(p => p.district), ...allEvents.map(e => e.district)])].filter(Boolean).sort();
            districtSelect.innerHTML = `<option value="all">æ‰€æœ‰åœ°å€</option>` + districts.map(d => `<option value="${d}">${d}</option>`).join('');
            districtSelect.value = currentSelection;
        }

        // --- SEARCH & RENDER (Unchanged, includes your previous fixes) ---
        function performSearch() {
            const selectedSenses = Array.from(sensesContainer.querySelectorAll('.sense-btn.active')).map(btn => btn.dataset.sense);
            const selectedDistrict = districtSelect.value;
            const searchQuery = searchInput.value.toLowerCase();

            let results = [];
            if (currentFilter === 'all' || currentFilter === 'places') results.push(...allPlaces);
            if (currentFilter === 'all' || currentFilter === 'events') results.push(...allEvents);

            const filtered = results.filter(item => {
                const name = item.name || item.title;
                if (!name) return false;
                
                const districtMatch = selectedDistrict === 'all' || item.district === selectedDistrict;
                const senses = item.senses || item.selected_senses || '';
                const sensesMatch = selectedSenses.length === 0 || selectedSenses.every(s => senses.includes(s));
                const searchMatch = searchQuery === '' || name.toLowerCase().includes(searchQuery);
                
                let dateMatch = true; 
                const isEvent = 'title' in item;
                if (isEvent && item.end_date) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 
                    const [year, month, day] = item.end_date.split('-').map(Number);
                    const eventEndDate = new Date(year, month - 1, day);
                    if (eventEndDate < today) {
                        dateMatch = false;
                    }
                }
                
                return districtMatch && sensesMatch && searchMatch && dateMatch;
            });
            renderResults(filtered);
        }

        function renderResults(results) {
            resultsGrid.innerHTML = '';
            resultsCount.textContent = `é¡¯ç¤º ${results.length} å€‹çµæœ`;
            loader.style.display = 'none';
            noResults.style.display = results.length === 0 ? 'block' : 'none';

            results.forEach((item, index) => {
                const isEvent = 'title' in item;
                const name = item.name || item.title;
                const senses = (item.senses || item.selected_senses || '').split(',').map(s => s.trim()).filter(Boolean);
                const color = stringToColor(name).substring(1);
                const placeholderImgUrl = `https://placehold.co/600x400/${color}/FFFFFF?text=${encodeURIComponent(name.charAt(0))}&font=raleway`;
                const card = document.createElement('div');
                card.className = 'result-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col fade-in';
                card.style.animationDelay = `${index * 50}ms`;
                card.innerHTML = `
                    <div class="aspect-video bg-gray-100"><img src="${placeholderImgUrl}" alt="${name}" class="w-full h-full object-cover"></div>
                    <div class="p-4 flex flex-col flex-grow">
                        <p class="text-xs font-semibold text-gray-500">${item.category || (isEvent ? 'æ´»å‹•' : 'åœ°é»')}</p>
                        <h3 class="font-bold text-lg mt-1">${name}</h3>
                        <p class="text-sm text-gray-500">${item.address || item.district}</p>
                        <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap gap-1.5">${senses.map(s => `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded-full">${s}</span>`).join('')}</div>
                        <div class="mt-auto pt-4"><button class="view-details-btn w-full bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">${isEvent ? 'æŸ¥çœ‹æ´»å‹•' : 'æŸ¥çœ‹å°åº—'}</button></div>
                    </div>
                `;
                card.querySelector('.view-details-btn').addEventListener('click', () => openModal(item));
                resultsGrid.appendChild(card);
            });
        }
        
        function openModal(item) {
            const isEvent = 'title' in item;
            const name = item.name || item.title;
            const senses = (item.senses || item.selected_senses || '').split(',').map(s => s.trim()).filter(Boolean);
            const color = stringToColor(name).substring(1);
            const placeholderImgUrl = `https://placehold.co/800x400/${color}/FFFFFF?text=${encodeURIComponent(name)}&font=raleway`;
            
            let eventDateDisplay = '';
            if (isEvent) {
                let dateString = item.start_date || '';
                if (item.end_date && item.end_date !== item.start_date) {
                    dateString += ` - ${item.end_date}`;
                }
                let timeString = '';
                if (item.start_time) {
                    timeString = item.start_time;
                    if (item.end_time) {
                        timeString += ` - ${item.end_time}`;
                    }
                }
                eventDateDisplay = `
                    <div class="mt-2 text-sm text-gray-600 font-medium">
                        <p>ğŸ—“ï¸ <span class="ml-1">${dateString}</span></p>
                        ${timeString ? `<p class="mt-1">â° <span class="ml-1">${timeString}</span></p>` : ''}
                    </div>
                `;
            }

            modalContent.innerHTML = `
                <div class="relative">
                    <button id="modal-close-btn" class="absolute -top-2 -right-2 sm:-top-4 sm:-right-4 bg-white rounded-full p-1.5 shadow-md hover:bg-gray-100 transition-colors z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                    </button>
                    <div class="w-full aspect-video bg-gray-100 rounded-lg overflow-hidden mb-4"><img src="${placeholderImgUrl}" alt="${name}" class="w-full h-full object-cover"></div>
                    <h3 class="font-bold text-xl sm:text-2xl">${name}</h3>
                    <p class="text-gray-500 mt-1">${item.address || item.district}</p>
                    ${eventDateDisplay}
                    <div class="mt-4 pt-4 border-t flex flex-wrap gap-2">${senses.map(s => `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded-full">${s}</span>`).join('')}</div>
                    <p class="text-gray-600 mt-4">${item.description || 'æš«ç„¡æè¿°ã€‚'}</p>
                    <div class="mt-6"><a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block w-full text-center bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">${isEvent ? 'å‰å¾€æ´»å‹•ç¶²ç«™' : 'å‰å¾€å°åº—ç¶²ç«™'}</a></div>
                </div>
            `;
            modalBackdrop.classList.remove('hidden');
            setTimeout(() => modalBackdrop.classList.remove('modal-enter'), 10);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        }

        function closeModal() {
            modalBackdrop.classList.add('modal-enter');
            setTimeout(() => modalBackdrop.classList.add('hidden'), 300);
        }

        // --- EVENT LISTENERS (Unchanged + New Listeners) ---
        districtSelect.addEventListener('change', performSearch);
        searchInput.addEventListener('input', performSearch);
        resultFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                resultFilterButtons.forEach(btn => btn.classList.remove('active', 'bg-gray-200'));
                button.classList.add('active');
                currentFilter = button.dataset.filter;
                performSearch();
            });
        });
        modalBackdrop.addEventListener('click', e => { if (e.target === modalBackdrop) closeModal(); });

        // â–¼â–¼â–¼ NEW EVENT LISTENERS FOR TABS â–¼â–¼â–¼
        tabExplore.addEventListener('click', () => showView('explore'));
        tabPlan.addEventListener('click', () => showView('plan'));
        planLoginBtn.addEventListener('click', handleSignIn);
        // â–²â–²â–² NEW EVENT LISTENERS FOR TABS â–²â–²â–²

        // --- INITIALIZATION ---
        populateSenses();
        fetchData();
        
    </script>
</body>
</html>

